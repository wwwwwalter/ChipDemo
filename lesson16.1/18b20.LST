C51 COMPILER V9.02   18B20                                                                 06/01/2019 11:15:07 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE 18B20
OBJECT MODULE PLACED IN 18b20.OBJ
COMPILER INVOKED BY: C:\Dev\program\51\C51\BIN\C51.EXE 18b20.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg52.h>
   2          #include <intrins.h>
   3          
   4          sbit IO_18B20=P3^7;
   5          unsigned char code LedCharYin[] = {
   6                  0x3f, 0x06, 0x5b, 0x4f,
   7                  0x66, 0x6d, 0x7d, 0x07,
   8                  0x7f, 0x6f, 0x77, 0x7c,
   9                  0x39, 0x5e, 0x79, 0x71,
  10                  0x40,0x00
  11          };
  12          unsigned char LedBuff[8] = {    
  13                  0xff,0xff,0xff,0xff,
  14                  0x00,0x00,0x00,0x00
  15          };
  16          unsigned char out[] = {
  17                  0x00,
  18                  0x00,0x00,
  19                  0x00,0x00,0x00,0x00
  20          };
  21          
  22          
  23          
  24          bit Get18B20Ack();
  25          bit Start18B20();
  26          bit Get18B20Temp(int *temp);
  27          void Write18B20(unsigned char dat);
  28          unsigned char Read18B20();
  29          void Delay10us(unsigned char t);
  30          void ConfigTimer0(unsigned char ms);
  31          void ConfigTimer1(unsigned char ms);
  32          void convert(unsigned char *out);
  33          
  34          unsigned char T0RH=0;
  35          unsigned char T0RL=0;
  36          unsigned char T1RH=0;
  37          unsigned char T1RL=0;
  38          
  39          bit flag=0;
  40          int temp;
  41          unsigned char intT;
  42          unsigned int decT;
  43          
  44          
  45          int main(void){          
  46   1         EA=1;
  47   1         Start18B20();
  48   1         _nop_();
  49   1         _nop_();
  50   1         ConfigTimer0(1);
  51   1         ConfigTimer1(1000);
  52   1         PT0=1;
  53   1      
  54   1         while(1){
  55   2                      if(flag){
C51 COMPILER V9.02   18B20                                                                 06/01/2019 11:15:07 PAGE 2   

  56   3                              flag=0;
  57   3                              convert(out);
  58   3                              LedBuff[6]=LedCharYin[out[6]];                          
  59   3                              LedBuff[5]=LedCharYin[out[5]];
  60   3                              LedBuff[4]=LedCharYin[out[4]];
  61   3                              LedBuff[4]|=0x80;
  62   3                              LedBuff[3]=LedCharYin[out[3]];
  63   3                              LedBuff[2]=LedCharYin[out[2]];
  64   3                              LedBuff[1]=LedCharYin[out[1]];
  65   3                              LedBuff[0]=LedCharYin[out[0]];
  66   3                      }
  67   2         }
  68   1      }
  69          
  70          void convert(unsigned char *out){
  71   1              unsigned char i = 0;
  72   1              
  73   1              bit sig = temp>>15&0x01;        
  74   1              intT=temp>>4&0x7f;
  75   1              decT=temp&0x0f;
  76   1      
  77   1              decT=decT*10000/16;
  78   1              out[i++]=decT%10;
  79   1              out[i++]=decT/10%10;
  80   1              out[i++]=decT/100%10;
  81   1              out[i++]=decT/1000%10;
  82   1      
  83   1              out[i++]=intT%10;
  84   1              out[i++]=intT/10%10;
  85   1      
  86   1              if(sig==0){out[i]=17;}
  87   1              else{out[i]=16;}
  88   1      }
  89          
  90          
  91          void ConfigTimer0(unsigned char ms){
  92   1              unsigned long tmp;
  93   1              tmp=12000000/12/1000*ms;
  94   1              tmp=65536-tmp;
  95   1              tmp+=12;
  96   1              T0RH=(unsigned char)(tmp>>8);
  97   1              T0RL=(unsigned char)tmp;
  98   1              TMOD&=0xf0;
  99   1              TMOD|=0x01;
 100   1              TH0=T0RH;
 101   1              TL0=T0RL;
 102   1              ET0=1;
 103   1              TR0=1;
 104   1      }
 105          void LedScan(){
 106   1              static unsigned char i=0;
 107   1              P0=0x00;
 108   1              P1=(P1&0xf8)|~i;
 109   1              P0=LedBuff[i];
 110   1              if(i<sizeof(LedBuff)-1){
 111   2                      i++;
 112   2              }else{
 113   2                      i=0;
 114   2              }
 115   1      }
 116          
 117          void InterruptTimer0() interrupt 1{     
C51 COMPILER V9.02   18B20                                                                 06/01/2019 11:15:07 PAGE 3   

 118   1              TH0=T0RH;
 119   1              TL0=T0RL;
 120   1              LedScan();
 121   1      }
 122          
 123          void ConfigTimer1(unsigned char ms){
 124   1              unsigned long tmp;
 125   1              tmp=12000000/12/1000*ms;
 126   1              tmp=65536-tmp;
 127   1              tmp+=12;
 128   1              T1RH=(unsigned char)(tmp>>8);
 129   1              T1RL=(unsigned char)tmp;
 130   1              TMOD&=0x0f;
 131   1              TMOD|=0x10;
 132   1              TH1=T1RH;
 133   1              TL1=T1RL;
 134   1              ET1=1;
 135   1              TR1=1;
 136   1      }
 137          
 138          void InterruptTimer1() interrupt 3{
 139   1              TH1=T1RH;
 140   1              TL1=T1RL;
 141   1              Get18B20Temp(&temp);
 142   1              Start18B20();
 143   1              flag=1;
 144   1      }
 145          
 146          
 147          
 148          
 149          void Delay10us(unsigned char t){
 150   1              do{
 151   2                      _nop_();
 152   2                      _nop_();
 153   2                      _nop_();
 154   2                      _nop_();
 155   2                      _nop_();
 156   2                      _nop_();
 157   2                      _nop_();
 158   2                      _nop_();
 159   2              }while(--t);
 160   1      }
 161          
 162          bit Get18B20Ack(){
 163   1              bit ack;
 164   1              EA=0;
 165   1              IO_18B20=0;
 166   1              Delay10us(50);
 167   1              IO_18B20=1;
 168   1              Delay10us(6);
 169   1              ack=IO_18B20;
 170   1              while(!IO_18B20);
 171   1              EA=1;
 172   1              return ack;
 173   1      }
 174          
 175          void Write18B20(unsigned char dat){
 176   1              unsigned char mask;
 177   1              EA=0;
 178   1              for(mask=0x01;mask!=0;mask<<=1){
 179   2                      IO_18B20 = 0;
C51 COMPILER V9.02   18B20                                                                 06/01/2019 11:15:07 PAGE 4   

 180   2                      _nop_();
 181   2                      _nop_();
 182   2                      if((mask&dat)==0){
 183   3                              IO_18B20=0;
 184   3                      }else{
 185   3                              IO_18B20=1;
 186   3                      }
 187   2                      Delay10us(6);
 188   2                      IO_18B20=1;
 189   2              }
 190   1              EA=1;
 191   1      }
 192          
 193          unsigned char Read18B20(){
 194   1              unsigned char dat;
 195   1              unsigned char mask;
 196   1      
 197   1              EA=0;
 198   1              for(mask=0x01;mask!=0;mask<<=1){
 199   2                      IO_18B20 = 0;
 200   2                      _nop_();
 201   2                      _nop_();
 202   2                      IO_18B20= 1;
 203   2                      _nop_();
 204   2                      _nop_();
 205   2                      if(!IO_18B20){
 206   3                              dat&=~mask;
 207   3                      }else{
 208   3                              dat|=mask;
 209   3                      }
 210   2                      Delay10us(6);
 211   2              }
 212   1              EA=1;
 213   1              return dat;
 214   1      }                                   
 215          
 216          bit Start18B20(){
 217   1              bit ack;
 218   1              ack=Get18B20Ack();
 219   1              if(ack==0){
 220   2                      Write18B20(0xcc);
 221   2                      Write18B20(0x44);
 222   2              }
 223   1              return ~ack;
 224   1      }
 225          bit Get18B20Temp(int *temp){
 226   1              bit ack;
 227   1              unsigned char LSB,MSB;
 228   1              ack=Get18B20Ack();
 229   1      
 230   1              if(ack==0){
 231   2                      Write18B20(0xcc);
 232   2                      Write18B20(0xBE);
 233   2                      LSB=Read18B20();
 234   2                      MSB=Read18B20();
 235   2                      *temp=((int)MSB<<8)+LSB;
 236   2              }
 237   1              return ~ack;
 238   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V9.02   18B20                                                                 06/01/2019 11:15:07 PAGE 5   

   CODE SIZE        =    904    ----
   CONSTANT SIZE    =     18    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     25      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       4
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
