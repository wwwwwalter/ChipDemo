C51 COMPILER V9.60.0.0   MAIN                                                              06/05/2019 12:26:09 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Dev\program\51keil9\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg52.h>
   2          
   3          typedef struct sTime{
   4                  unsigned int year;
   5                  unsigned char mon;
   6                  unsigned char day;
   7                  unsigned char hour;
   8                  unsigned char min;
   9                  unsigned char sec;
  10                  unsigned char week;
  11          }Time;
  12          
  13          extern void InitDS1302();
  14          extern void GetRealTime(Time *time);
  15          extern void SetRealTime(Time *time);
  16          extern void LedScan();
  17          extern void LedLoad(unsigned char index,unsigned char dat);
  18          extern void KeyGet();
  19          extern void KeyScan();
  20          extern void ConfigTimer1(unsigned int ms);
  21          extern void uart_send_string(unsigned char *str);
  22          
  23          void ConfigTimer0(unsigned int ms);
  24          void ConfigUART(unsigned int baud);
  25          void LoadTime(Time *time);
  26          void KeyAction(unsigned char keycode);
  27          void timeToString(Time *time,unsigned char *str);
  28          
  29          
  30          
  31          
  32          
  33          bit flag200ms=1;
  34          bit flag1s=1;
  35          unsigned char T0RH=0;
  36          unsigned char T0RL=0;
  37          unsigned long code freq=24000000;
  38          unsigned char settime=0;
  39          unsigned char uartRecvByte=0;
  40          unsigned char recvflag=0;
  41          
  42          
  43          
  44          void main(){
  45   1         unsigned char backsec=0xAA;
  46   1         unsigned char str[9]={'\0'};
  47   1         Time time = {0};   
  48   1      
  49   1         EA=1;
  50   1         ConfigTimer0(1);  
  51   1         ConfigUART(9600);
  52   1         InitDS1302();
  53   1      
  54   1         while(1){
  55   2                 KeyGet();       
C51 COMPILER V9.60.0.0   MAIN                                                              06/05/2019 12:26:09 PAGE 2   

  56   2                 if(flag200ms&&(settime==0)){
  57   3                         flag200ms=0;
  58   3                         GetRealTime(&time);             
  59   3                         if(time.sec!=backsec){
  60   4                                      LoadTime(&time);                                
  61   4                                      backsec=time.sec;
  62   4                         }
  63   3                 }
  64   2                 if(flag1s){
  65   3                         flag1s=0;
  66   3                         timeToString(&time,str);
  67   3                         uart_send_string(str);
  68   3                 }
  69   2         }
  70   1      }
  71          
  72          void ConfigTimer0(unsigned int ms){
  73   1              unsigned long tmp;
  74   1              tmp=freq/12/1000*ms;
  75   1              tmp=65536-tmp;
  76   1              tmp+=12;
  77   1              T0RH=(unsigned char)(tmp>>8);
  78   1              T0RL=(unsigned char)tmp;
  79   1              TMOD&=0xf0;
  80   1              TMOD|=0x01;
  81   1              TH0=T0RH;
  82   1              TL0=T0RL;
  83   1              ET0=1;
  84   1              TR0=1;
  85   1      }
  86          /*
  87          void ConfigTimer1(unsigned int ms){
  88                  unsigned long tmp;
  89                  tmp=freq/12/1000*ms;
  90                  tmp=65536-tmp;
  91                  tmp+=12;
  92                  T1RH=(unsigned char)(tmp>>8);
  93                  T1RL=(unsigned char)tmp;
  94                  TMOD&=0x0f;
  95                  TMOD|=0x10;
  96                  TH1=T1RH;
  97                  TL1=T1RL;
  98                  ET1=1;
  99                  TR1=1;
 100          }
 101          void InterruptTimer1() interrupt 3{     
 102                  TH1=T1RH;
 103                  TL1=T1RL;
 104                  KeyScan();      
 105          }*/
 106          
 107          
 108          void InterruptTimer0() interrupt 1{
 109   1              static unsigned char i = 0;     
 110   1              static unsigned int j = 0;
 111   1              TH0=T0RH;
 112   1              TL0=T0RL;       
 113   1              LedScan();
 114   1              KeyScan();      
 115   1              i++;
 116   1              if(i>=200){
 117   2                      i=0;
C51 COMPILER V9.60.0.0   MAIN                                                              06/05/2019 12:26:09 PAGE 3   

 118   2                      flag200ms=1;            
 119   2              }
 120   1              j++;
 121   1              if(j>=1000){
 122   2                      j=0;
 123   2                      flag1s=1;
 124   2              }
 125   1      }
 126          
 127          
 128          void LoadTime(Time *time){      
 129   1              LedLoad(2,time->sec&0x0f);
 130   1              LedLoad(3,time->sec>>4&0x07);
 131   1              LedLoad(4,time->min&0x0f);
 132   1              LedLoad(5,time->min>>4&0x07);
 133   1              LedLoad(6,time->hour&0x0f);
 134   1              LedLoad(7,time->hour>>4&0x03);
 135   1      }
 136          
 137          void timeToString(Time *time,unsigned char *str){
 138   1              str[0]=time->year>>8;
 139   1              str[1]=time->year&0xff;
 140   1              str[2]=time->mon;
 141   1              str[3]=time->day;
 142   1              str[4]=time->hour;
 143   1              str[5]=time->min;
 144   1              str[6]=time->sec;
 145   1              str[7]=time->week;
 146   1              str[8]='\0';
 147   1      }
 148          
 149          void KeyAction(unsigned char keycode){
 150   1              if((keycode>='0')&&(keycode<='9')){             
 151   2                      LedLoad(0,0);           
 152   2                      uart_send_string("hello world:123456789");
 153   2              }else if(keycode==0x26){
 154   2                      LedLoad(0,1);
 155   2              }else if(keycode==0x28){
 156   2                      LedLoad(0,2);
 157   2              }else if(keycode==0x25){
 158   2                      LedLoad(0,3);
 159   2              }else if(keycode==0x27){
 160   2                      LedLoad(0,4);
 161   2              }else if(keycode==0x0d){
 162   2                      LedLoad(0,5);
 163   2                      uart_send_string("setting or confirm");
 164   2              }else if(keycode==0x1b){
 165   2                      LedLoad(0,14);
 166   2              }else{
 167   2                      ;
 168   2              }
 169   1      }
 170          
 171          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    794    ----
   CONSTANT SIZE    =     62    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8      34
C51 COMPILER V9.60.0.0   MAIN                                                              06/05/2019 12:26:09 PAGE 4   

   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
