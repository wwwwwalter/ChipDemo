C51 COMPILER V9.02   18B20                                                                 06/01/2019 11:47:32 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE 18B20
OBJECT MODULE PLACED IN 18b20.OBJ
COMPILER INVOKED BY: C:\Dev\program\51\C51\BIN\C51.EXE 18b20.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg52.h>
   2          #include <intrins.h>
   3          
   4          sbit IO_18B20=P3^7;
   5          sbit TURN=P2^0;
   6          
   7          unsigned char code LedCharYin[] = {
   8                  0x3f, 0x06, 0x5b, 0x4f,
   9                  0x66, 0x6d, 0x7d, 0x07,
  10                  0x7f, 0x6f, 0x77, 0x7c,
  11                  0x39, 0x5e, 0x79, 0x71,
  12                  0x40,0x00
  13          };
  14          unsigned char LedBuff[8] = {    
  15                  0xff,0xff,0xff,0xff,
  16                  0x00,0x00,0x00,0x00
  17          };
  18          unsigned char out[] = {
  19                  0x00,
  20                  0x00,0x00,
  21                  0x00,0x00,0x00,0x00
  22          };
  23          
  24          
  25          
  26          bit Get18B20Ack();
  27          bit Start18B20();
  28          bit Get18B20Temp(int *temp);
  29          void Write18B20(unsigned char dat);
  30          unsigned char Read18B20();
  31          void Delay10us(unsigned char t);
  32          void ConfigTimer0(unsigned char ms);
  33          void ConfigTimer1(unsigned char ms);
  34          void convert(unsigned char *out);
  35          
  36          unsigned char T0RH=0;
  37          unsigned char T0RL=0;
  38          unsigned char T1RH=0;
  39          unsigned char T1RL=0;
  40          
  41          bit flag=0;
  42          int temp;
  43          unsigned char intT;
  44          unsigned int decT;
  45          
  46          
  47          int main(void){          
  48   1         EA=1;
  49   1         Start18B20();
  50   1         _nop_();
  51   1         _nop_();
  52   1         ConfigTimer0(1);
  53   1         ConfigTimer1(1000);
  54   1         PT0=1;
  55   1      
C51 COMPILER V9.02   18B20                                                                 06/01/2019 11:47:32 PAGE 2   

  56   1         while(1){
  57   2                      if(flag){
  58   3                              flag=0;
  59   3                              convert(out);
  60   3                              LedBuff[6]=LedCharYin[out[6]];                          
  61   3                              LedBuff[5]=LedCharYin[out[5]];
  62   3                              LedBuff[4]=LedCharYin[out[4]];
  63   3                              LedBuff[4]|=0x80;
  64   3                              LedBuff[3]=LedCharYin[out[3]];
  65   3                              LedBuff[2]=LedCharYin[out[2]];
  66   3                              LedBuff[1]=LedCharYin[out[1]];
  67   3                              LedBuff[0]=LedCharYin[out[0]];
  68   3                      }
  69   2         }
  70   1      }
  71          
  72          void convert(unsigned char *out){
  73   1              unsigned char i = 0;
  74   1              
  75   1              bit sig = temp>>15&0x01;        
  76   1              intT=temp>>4&0x7f;
  77   1              decT=temp&0x0f;
  78   1      
  79   1              decT=decT*10000/16;
  80   1              out[i++]=decT%10;
  81   1              out[i++]=decT/10%10;
  82   1              out[i++]=decT/100%10;
  83   1              out[i++]=decT/1000%10;
  84   1      
  85   1              out[i++]=intT%10;
  86   1              out[i++]=intT/10%10;
  87   1      
  88   1              if(sig==0){out[i]=17;}
  89   1              else{out[i]=16;}
  90   1      
  91   1              if(intT>=25){TURN=0;}
  92   1              else{TURN=1;}
  93   1      }
  94          
  95          
  96          void ConfigTimer0(unsigned char ms){
  97   1              unsigned long tmp;
  98   1              tmp=12000000/12/1000*ms;
  99   1              tmp=65536-tmp;
 100   1              tmp+=12;
 101   1              T0RH=(unsigned char)(tmp>>8);
 102   1              T0RL=(unsigned char)tmp;
 103   1              TMOD&=0xf0;
 104   1              TMOD|=0x01;
 105   1              TH0=T0RH;
 106   1              TL0=T0RL;
 107   1              ET0=1;
 108   1              TR0=1;
 109   1      }
 110          void LedScan(){
 111   1              static unsigned char i=0;
 112   1              P0=0x00;
 113   1              P1=(P1&0xf8)|~i;
 114   1              P0=LedBuff[i];
 115   1              if(i<sizeof(LedBuff)-1){
 116   2                      i++;
 117   2              }else{
C51 COMPILER V9.02   18B20                                                                 06/01/2019 11:47:32 PAGE 3   

 118   2                      i=0;
 119   2              }
 120   1      }
 121          
 122          void InterruptTimer0() interrupt 1{     
 123   1              TH0=T0RH;
 124   1              TL0=T0RL;
 125   1              LedScan();
 126   1      }
 127          
 128          void ConfigTimer1(unsigned char ms){
 129   1              unsigned long tmp;
 130   1              tmp=12000000/12/1000*ms;
 131   1              tmp=65536-tmp;
 132   1              tmp+=12;
 133   1              T1RH=(unsigned char)(tmp>>8);
 134   1              T1RL=(unsigned char)tmp;
 135   1              TMOD&=0x0f;
 136   1              TMOD|=0x10;
 137   1              TH1=T1RH;
 138   1              TL1=T1RL;
 139   1              ET1=1;
 140   1              TR1=1;
 141   1      }
 142          
 143          void InterruptTimer1() interrupt 3{
 144   1              TH1=T1RH;
 145   1              TL1=T1RL;
 146   1              Get18B20Temp(&temp);
 147   1              Start18B20();
 148   1              flag=1;
 149   1      }
 150          
 151          
 152          
 153          
 154          void Delay10us(unsigned char t){
 155   1              do{
 156   2                      _nop_();
 157   2                      _nop_();
 158   2                      _nop_();
 159   2                      _nop_();
 160   2                      _nop_();
 161   2                      _nop_();
 162   2                      _nop_();
 163   2                      _nop_();
 164   2              }while(--t);
 165   1      }
 166          
 167          bit Get18B20Ack(){
 168   1              bit ack;
 169   1              EA=0;
 170   1              IO_18B20=0;
 171   1              Delay10us(50);
 172   1              IO_18B20=1;
 173   1              Delay10us(6);
 174   1              ack=IO_18B20;
 175   1              while(!IO_18B20);
 176   1              EA=1;
 177   1              return ack;
 178   1      }
 179          
C51 COMPILER V9.02   18B20                                                                 06/01/2019 11:47:32 PAGE 4   

 180          void Write18B20(unsigned char dat){
 181   1              unsigned char mask;
 182   1              EA=0;
 183   1              for(mask=0x01;mask!=0;mask<<=1){
 184   2                      IO_18B20 = 0;
 185   2                      _nop_();
 186   2                      _nop_();
 187   2                      if((mask&dat)==0){
 188   3                              IO_18B20=0;
 189   3                      }else{
 190   3                              IO_18B20=1;
 191   3                      }
 192   2                      Delay10us(6);
 193   2                      IO_18B20=1;
 194   2              }
 195   1              EA=1;
 196   1      }
 197          
 198          unsigned char Read18B20(){
 199   1              unsigned char dat;
 200   1              unsigned char mask;
 201   1      
 202   1              EA=0;
 203   1              for(mask=0x01;mask!=0;mask<<=1){
 204   2                      IO_18B20 = 0;
 205   2                      _nop_();
 206   2                      _nop_();
 207   2                      IO_18B20= 1;
 208   2                      _nop_();
 209   2                      _nop_();
 210   2                      if(!IO_18B20){
 211   3                              dat&=~mask;
 212   3                      }else{
 213   3                              dat|=mask;
 214   3                      }
 215   2                      Delay10us(6);
 216   2              }
 217   1              EA=1;
 218   1              return dat;
 219   1      }                                   
 220          
 221          bit Start18B20(){
 222   1              bit ack;
 223   1              ack=Get18B20Ack();
 224   1              if(ack==0){
 225   2                      Write18B20(0xcc);
 226   2                      Write18B20(0x44);
 227   2              }
 228   1              return ~ack;
 229   1      }
 230          bit Get18B20Temp(int *temp){
 231   1              bit ack;
 232   1              unsigned char LSB,MSB;
 233   1              ack=Get18B20Ack();
 234   1      
 235   1              if(ack==0){
 236   2                      Write18B20(0xcc);
 237   2                      Write18B20(0xBE);
 238   2                      LSB=Read18B20();
 239   2                      MSB=Read18B20();
 240   2                      *temp=((int)MSB<<8)+LSB;
 241   2              }
C51 COMPILER V9.02   18B20                                                                 06/01/2019 11:47:32 PAGE 5   

 242   1              return ~ack;
 243   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    916    ----
   CONSTANT SIZE    =     18    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     25      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       4
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
