C51 COMPILER V9.60.0.0   MAIN                                                              06/05/2019 14:59:33 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Dev\program\51keil9\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg52.h>
   2          
   3          typedef struct sTime{
   4                  unsigned int year;
   5                  unsigned char mon;
   6                  unsigned char day;
   7                  unsigned char hour;
   8                  unsigned char min;
   9                  unsigned char sec;
  10                  unsigned char week;
  11          }Time;
  12          
  13          extern void InitDS1302();
  14          extern void GetRealTime(Time *time);
  15          extern void SetRealTime(Time *time);
  16          extern void LedScan();
  17          extern void LedLoad(unsigned char index,unsigned char dat);
  18          extern void KeyGet();
  19          extern void KeyScan();
  20          extern void ConfigTimer1(unsigned int ms);
  21          extern void uart_send_string(unsigned char *str);
  22          extern void uart_send_hex_string(unsigned char *str,unsigned int len);
  23          
  24          void ConfigTimer0(unsigned int ms);
  25          void ConfigUART(unsigned int baud);
  26          void LoadTime(Time *time);
  27          void KeyAction(unsigned char keycode);
  28          void timeToHexString(Time *time,unsigned char *str);
  29          
  30          
  31          bit flag200ms=1;
  32          bit flag1s=1;
  33          unsigned char T0RH=0;
  34          unsigned char T0RL=0;
  35          unsigned long code freq=24000000;
  36          unsigned char settime=0;
  37          unsigned char uartRecvByte=0;
  38          unsigned char recvflag=0;
  39          
  40          
  41          
  42          void main(){
  43   1         unsigned char backsec=0xAA;
  44   1         unsigned char str[9]={'\0'};
  45   1         Time time = {0};   
  46   1      
  47   1         EA=1;
  48   1         ConfigTimer0(1);
  49   1         ConfigUART(9600);
  50   1         InitDS1302();
  51   1      
  52   1         while(1){
  53   2                 KeyGet();       
  54   2                 if(flag200ms&&(settime==0)){
  55   3                         flag200ms=0;
C51 COMPILER V9.60.0.0   MAIN                                                              06/05/2019 14:59:33 PAGE 2   

  56   3                         GetRealTime(&time);             
  57   3                         if(time.sec!=backsec){
  58   4                                      LoadTime(&time);                                
  59   4                                      backsec=time.sec;
  60   4                         }
  61   3                 }
  62   2                 if(flag1s){
  63   3                         flag1s=0;
  64   3                         timeToHexString(&time,str);
  65   3                         uart_send_hex_string(str,8);
  66   3                 }
  67   2         }
  68   1      }
  69          
  70          void ConfigTimer0(unsigned int ms){
  71   1              unsigned long tmp;
  72   1              tmp=freq/12/1000*ms;
  73   1              tmp=65536-tmp;
  74   1              tmp+=12;
  75   1              T0RH=(unsigned char)(tmp>>8);
  76   1              T0RL=(unsigned char)tmp;
  77   1              TMOD&=0xf0;
  78   1              TMOD|=0x01;
  79   1              TH0=T0RH;
  80   1              TL0=T0RL;
  81   1              ET0=1;
  82   1              TR0=1;
  83   1              PT0=1; 
  84   1      }
  85          /*
  86          void ConfigTimer1(unsigned int ms){
  87                  unsigned long tmp;
  88                  tmp=freq/12/1000*ms;
  89                  tmp=65536-tmp;
  90                  tmp+=12;
  91                  T1RH=(unsigned char)(tmp>>8);
  92                  T1RL=(unsigned char)tmp;
  93                  TMOD&=0x0f;
  94                  TMOD|=0x10;
  95                  TH1=T1RH;
  96                  TL1=T1RL;
  97                  ET1=1;
  98                  TR1=1;
  99          }
 100          void InterruptTimer1() interrupt 3{     
 101                  TH1=T1RH;
 102                  TL1=T1RL;
 103                  KeyScan();      
 104          }*/
 105          
 106          
 107          void InterruptTimer0() interrupt 1{
 108   1              static unsigned char i = 0;     
 109   1              static unsigned int j = 0;
 110   1              TH0=T0RH;
 111   1              TL0=T0RL;       
 112   1              LedScan();
 113   1              KeyScan();      
 114   1              i++;
 115   1              if(i>=200){
 116   2                      i=0;
 117   2                      flag200ms=1;            
C51 COMPILER V9.60.0.0   MAIN                                                              06/05/2019 14:59:33 PAGE 3   

 118   2              }
 119   1              j++;
 120   1              if(j>=1000){
 121   2                      j=0;
 122   2                      flag1s=1;
 123   2              }
 124   1      }
 125          
 126          
 127          void LoadTime(Time *time){      
 128   1              LedLoad(2,time->sec&0x0f);
 129   1              LedLoad(3,time->sec>>4&0x07);
 130   1              LedLoad(4,time->min&0x0f);
 131   1              LedLoad(5,time->min>>4&0x07);
 132   1              LedLoad(6,time->hour&0x0f);
 133   1              LedLoad(7,time->hour>>4&0x03);
 134   1      }
 135          
 136          void timeToHexString(Time *time,unsigned char *str){
 137   1              str[0]=time->year>>8;
 138   1              str[1]=time->year&0xff;
 139   1              str[2]=time->mon;
 140   1              str[3]=time->day;
 141   1              str[4]=time->hour;
 142   1              str[5]=time->min;
 143   1              str[6]=time->sec;
 144   1              str[7]=time->week;      
 145   1      }
 146          
 147          void KeyAction(unsigned char keycode){
 148   1              if((keycode>='0')&&(keycode<='9')){             
 149   2                      LedLoad(0,0);           
 150   2                      uart_send_string("hello world:123456789");
 151   2              }else if(keycode==0x26){
 152   2                      LedLoad(0,1);
 153   2              }else if(keycode==0x28){
 154   2                      LedLoad(0,2);
 155   2              }else if(keycode==0x25){
 156   2                      LedLoad(0,3);
 157   2              }else if(keycode==0x27){
 158   2                      LedLoad(0,4);
 159   2              }else if(keycode==0x0d){
 160   2                      LedLoad(0,5);
 161   2                      uart_send_string("setting or confirm");
 162   2              }else if(keycode==0x1b){
 163   2                      LedLoad(0,14);
 164   2              }else{
 165   2                      ;
 166   2              }
 167   1      }
 168          
 169          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    793    ----
   CONSTANT SIZE    =     62    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8      34
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
C51 COMPILER V9.60.0.0   MAIN                                                              06/05/2019 14:59:33 PAGE 4   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
